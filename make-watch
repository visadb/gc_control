#!/usr/bin/env bash

inotifywait -r -m -q -e close_write $(dirname $0) \
  | while read path event file; do
      if case $file in
          autogenerated.h)   false;;   # ignore a specific file to avoid loops
          *.c|*.h|*.S|Makefile)  true;;    # watch all .c, .h files, the Makefile
          *)                 false;;   # ignore all other files to avoid loops
      esac; then
        OLD_TIMEOUTS=$(ps -C timeout -o pid=,args=|grep "make upload"|cut -d' ' -f1)
        if [ -n "$OLD_TIMEOUTS" ]; then
          echo "Killing old makes: "$OLD_TIMEOUTS
          kill $OLD_TIMEOUTS
        fi
        (cd $(dirname $0) && timeout 10m make $@) &
      fi
    done
